#!/bin/bash
set -ex

if test ! -f .toldem ; then
cat <<'EOF'

Hi.

FÜR ABSTÜRZE, DATENVERLUST UND ÄHNLICHE PROBLEME ÜBERNEHME ICH KEINERLEI
WIE AUCH IMMER GEARTETE HAFTUNG.

Wem das nicht paßt, der lösche diesen Code. Jetzt.

Ansonsten: Erst DOKU lesen (im isdn-Verzeichnis)!

Dann ggf. die Patches auf den aktuellen Kernel (momentan 1.2.11) anwenden,
Kernel bauen, booten. Nachsehen ob das System noch funktioniert.

Dann config/config.data und cards/dumb/Config.c ansehen und gegebenenfalls
ändern.

Dann nochmal make.isdn aufrufen.

Die gebauten Module können automatisch beim Booten geladen werden mit
folgendem Skript irgendwo in der Bootsequenz:

>  ( cd /lib/modules/$(uname -r); echo -n "ISDN for kernel $(uname -r): "
>    while read a ; do echo -n $a "" ; insmod $a ; done < ../modules.isdn
>    echo ""
>  )

Vorher: In /lib/modules/KERNELVERSION: modules.isdn.all nach modules.isdn
        kopieren; nicht benötigte Module ggf. aus dieser Datei rauswerfen.

EOF
touch .toldem
exit 1
fi

if test -f make.isdn.local ; then 
. make.isdn.local $*
fi

VERSION=$(tools/getversion)

if test "$(whoami)" = "root" ; then
dir=/lib/modules/$VERSION/isdn
if test ! -d $dir ; then mkdir -p $dir ; fi
cp /dev/null $dir/modules.isdn.all
if test ! -f .depend ; then make depend && touch .depend ; fi
	PATH=$(pwd)/tools:$PATH make load
	make iprog
	test -f /etc/rc.d/rc.isdn || cp tools/rc.isdn /etc/rc.d/rc.isdn
	if test -f /lib/modules/modules.isdn ; then 
		echo "Ist /lib/modules/modules.isdn auf dem neuesten Stand?"
	else
		cp /lib/modules/modules.isdn.full /lib/modules.isdn"
		echo "In /lib/modules/modules.isdn anpassen!"
	fi
	if grep cardname /lib/modules/modules.isdn ; then : ; else
		echo "Die Treiber der Karten muessen parametrisiert sein!! -> DOKU."
	fi
else
	if test ! -f .depend ; then make depend ; fi
	make all
	make prog
fi
